<ion-view title="Timeline">
    <ion-content class="timeline-page" scroll="false">
        <div ng-show="!editMode" class="timeline-time">
            {{currentHour}}:{{currentMinutes}}
        </div>
        <div ng-class="['cancel-button', 'filled', selectedUserIndex === -1? 'selected':'']"
                ng-show="editMode && !editCalendarMode">
                Cancel
        </div>
        <div class="timeline-pictures" ng-click="goTo()">
            <div class="row timeline" ng-repeat="calendar in calendars track by $index">
                <div ng-class="['col', 'timelines' + calendars.length]">
                    <img ng-src="{{calendar.picture}}" ng-class="editMode && !editCalendarMode && selectedUserIndex === $index? 'selected' : ''"/>
                    <div ng-class="['cancel-button', 'filled', selectedCalendarIndex === -1? 'selected':'']"
                         ng-show="editCalendarMode && !editTransitOption && selectedUserIndex === $index">
                        Cancel
                    </div>
                </div>
            </div>
        </div>
        <ion-scroll direction="x" scrollbar-x="false" on-scroll="adjustMinimap()">
            <!--
                The visible width of the timeline is always 85vw since the left border is
                occupied by a 15vw wide picture container. 85vw always contain 4 full hours
                on the timeline which makes 1 hour === 85vw / 4 === 21.25vw.
                All calculations on this page are based upon these values.
            -->
            <div class="row timeline-hours">
                <!-- Display the hour markers at the top of the screen.
                    One hour should take up 25% (horizontally) of the screen.-->
                <div class="col hour-marker"
                     ng-repeat="time in timerange track by $index">
                    {{time}}
                </div>
            </div>
            <div class="timeline-current-marker"
                 ng-style="{'transform':
                    'translate3d(' + timelineMarkerPosition + 'vw, -100vh, 1px)'}">
            </div>
            <div class="timelines">
                <div class="row timeline timeline-marker" ng-repeat="calendar in calendars">
                    <!-- Calculate the horizontal positioning of the elements.
                        This is divided into two parts:
                            'margin-left' is to care for the white space between the last calendar
                                event and the current one (or between 7am and the first event).
                            'flex' handles the amount of space the element should occupy given its duration.
                        We want to display four hours on one screen which makes 25% the equivalent for
                            one hour and what we use as a multiplier.
                        The rest of the logic is subtracting the time of the current event from the
                            time of the last event (or 7am for the first event).
                        Since this is very dynamic, I didn't find a way to do it in CSS without making
                            classes for every percentage and even then the percentage still would have
                            to be calculcated.-->
                    <div
                        ng-class="['col', 'timeline-cell', 'filled',
                            'timelines' + calendars.length,
                            selectEventMode && !editTransitOption && calendars[selectedUserIndex] === calendar && selectedCalendarIndex === $index?
                                'selected' : ''
                        ]"
                        ng-repeat="event in calendar.events track by $index"
                        ng-style="{
                            'margin-left': ((event.distanceToEventBeforeInMinutes / 60 * 25) + '%'),
                            'flex': '0 0 ' + (event.durationInMinutes / 60 * 25) + '%'
                        }">
                        <div
                            ng-class="['primary-transit-option',
                                editCalendarMode && !editTransitOption && calendars[selectedUserIndex] === calendar && selectedCalendarIndex === $index?
                                'selected' : '']"
                            ng-style="{
                                'width': ((event.userSelectedTransitOption? event.transit_options[event.userSelectedTransitOption].duration : event.optimized_transit.best.duration) / 60 * 25) + '%'
                            }"
                            ng-if="!editTransitOption || !(calendars[selectedUserIndex] === calendar && selectedCalendarIndex === $index)">
                            <i ng-class="['transit-option-icon', 'icon', 'ion-android-' + (event.userSelectedTransitOption? transitOptions[transitTranslations.indexOf(event.userSelectedTransitOption)] : transitOptions[transitTranslations.indexOf(event.optimized_transit.best.name)])]"></i>
                        </div>
                        <div
                            class="transit-options"
                            ng-if="editTransitOption && calendars[selectedUserIndex] === calendar && selectedCalendarIndex === $index">
                            <div ng-class="['transit-option', selectedTransitOptionIndex === $index? 'selected' : '' ]"
                                 ng-repeat="transitOption in transitOptions track by $index">
                                {{transitOption}}
                            </div>
                        </div>
                        <div class="event-title">
                            {{event.title}} @ {{event.location.split(',')[0]}}
                        </div>
                    </div>
                </div>
            </div>
        </ion-scroll>
        <div class="minimap">
            <div ng-class="['row', 'timeline', 'timeline-marker', 'timelines' + calendars.length]" ng-repeat="calendar in calendars track by $index">
                <div class="minimap-indicator"
                     ng-if="$index === 0"
                     ng-style="{'transform':
                        'translate3d(' + minimapScrollPosition + 'vw, 0, 0)'}"></div>
                <div
                    ng-class="['col', 'timeline-cell', 'filled']"
                    ng-repeat="event in calendar.events track by $index"
                    ng-style="{
                        'margin-left': ((event.distanceToEventBeforeInMinutes / 60 * 100 / 16.5) + '%'),
                        'flex': '0 0 ' + (event.durationInMinutes / 60 * 100 / 16.5) + '%'
                    }">
                </div>
            </div>
        </div>
    </ion-content>
</ion-view>